# dcprofiler

This project utilizes Moops DreamHAL perfcounter source code to count cycles.  So major credit to Moop.  Checkout DreamHal here: https://github.com/sega-dreamcast/dreamhal.

There is two parts to this project:  
1. The files you include in your project (profiler.c, profiler.h)
2. The application(dctrace) that parses the data (trace.txt) your dreamcast application generates.  This application is based on 
the project [HERE](https://web.archive.org/web/20130528172555/http://www.ibm.com/developerworks/library/l-graphvis/) but I added a counters so you can see how much time is spent in each function.

## Instructions:
1. Add profiler.c and profiler.h to you projects source directory.
2. Edit your makefile to add '-g -finstrument-functions' to your KOS_CFLAGS and 'profiler.o' to your OBJS.
3. Use dc-tool-ip to send your elf file to Dreamcast:
   ```sudo /PATH/TO/dc-tool-ip -c "/PATH/TO/PROJECT" -t 192.168.1.137 -x main.elf```
4. Profiling automatically starts when you start running the application so make sure to call shutdownProfiling() to stop profiling.
5. Run dctrace application on your elf with the command:
  ```dctrace main.elf```

This assumes a couple of things.  That your 'sh-elf-addr2line' application is in '/opt/toolchains/dc/sh-elf/bin/' directory and that your 
.elf file and trace.txt(generated by your application) file are the same directory. 

6.  That will generate a graph.dot file that you can use the following command to generate a jpg:
  ```dot -Tjpg graph.dot -o graph.jpg```

You will need the dot application in order generate an image. Here is info how to install (https://graphviz.org/download/). I installed dot on my mac using brew:  
  ```brew install graphviz```

Another method to view your DOT file and convert it to an image is to paste the contents of the .DOT file in this online editor: https://dreampuf.github.io/GraphvizOnline/

## TIPS:

1.  For any method you don't want to profile you just add ```__attribute__ ((no_instrument_function))``` to its protype or its definition (if there isnt a prototype). Or in your makefile use ```-finstrument-functions-exclude-function-list=sym,sym,...```

2.  You can also ignore a whole files you dont want to profile. Just add ```-finstrument-functions-exclude-file-list=file,file,...``` to your makefile

Here is an example of my Makefile:

```
TARGET = main.elf
DATETIME := $(shell date '+%Y-%m-%d_%I-%M-%S_%p')
...

profileip: $(TARGET)
	sudo /PATH/TO/dc-tool-ip -c "." -t 192.168.1.137 -x $(TARGET)

dot: 
	/PATH/TO/dctrace $(TARGET)

image: dot
	dot -Tjpg graph.dot -o graph_$(DATETIME).jpg
```
Then after I run the application using ```make profileip``` and exiting the application, I use the command ```make image``` to generate a graph.dot and graph.jpg file.

## WARNING: 

If the application is already has a low framerate(~15) chances are you are going to get a black screen when using this.  Trace data is still generated though so you can see what is consuming most of the time. This is project is mostly useful if you have a BBA. If you only have a serial cable it will make your application run even slower since it has to push so much trace data back to the computer.
