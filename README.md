# dcprofiler

WARNING: If the application is already has a low framerate(~15) chances are you are going to get a black screen when using this.  Trace data is still generated though so you can see what is consuming most of the time. This is project is mostly useful if you have a BBA. If you only have a serial cable it will make your application run even slower since it has to push so much trace data back to the computer.

This project utilizes Moops DreamHAL perfcounter source code to count cycles.  So major credit to Moop.  Checkout DreamHal here: https://github.com/sega-dreamcast/dreamhal.

There is two parts to this project:  
1. The files you include in your project (profiler.c, profiler.h)
2. The application(pvtrace) that parses the data (trace.txt) your dreamcast application generates.  This application is based on 
https://web.archive.org/web/20130528172555/http://www.ibm.com/developerworks/library/l-graphvis/ but I added a ton of stuff/details.

Instructions:
1. Add profiler.c and profiler.h to you projects source directory.
2. Edit your makefile to add '-g -finstrument-functions' to your KOS_CFLAGS and 'profiler.o' to your OBJS.
3. Use dc-tool-ip to send your elf file to Dreamcast:
   ```sudo /PATH/TO/dc-tool-ip -c "/PATH/TO/PROJECT" -t 192.168.1.137 -x main.elf```
4. Profiling automatically starts when you start running the application so make sure to call shutdownProfiling() to stop profiling.
5. Run pvtrace application on your elf with the command:
  ```pvtrace main.elf```

This assumes a couple of things.  That your 'sh-elf-addr2line' application is in '/opt/toolchains/dc/sh-elf/bin/' directory and that your 
.elf file and trace.txt(generated by your application) file are the same directory. 

6.  That will generate a graph.dot file that you can use the following command to generate a jpg:
  ```dot -Tjpg graph.dot -o graph.jpg```

You will need the dot application in order generate an image. Here is info how to install (https://graphviz.org/download/). I installed dot on my mac using brew:  
  ```brew install graphviz```

Another method to view your DOT file and convert it to an image is to paste the contents of the .DOT file in this online editor: https://dreampuf.github.io/GraphvizOnline/

TIPS:

I added these to my make file to make things easier:

```
TARGET = main.elf

...

profileip: $(TARGET)
	sudo /PATH/TO/dc-tool-ip -c "." -t 192.168.1.137 -x $(TARGET)

dot: 
	/PATH/TO/pvtrace $(TARGET)

image: dot
	dot -Tjpg graph.dot -o graph.jpg
```
Then after I run the application using ```make profileip``` and exiting the application, I use the command ```make image``` to generate a graph.dot and graph.jpg file.
